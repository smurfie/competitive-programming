(() => {
  function solve(input) {
    var map = input.split("\n").map((i) => i.split(""));
    var portals = {};
    var gates = {};
    for (var i = 0; i < map.length; i++) {
      for (var j = 0; j < map[i].length; j++) {
        if (isLetter(map, i, j) && isLetter(map, i + 1, j)) {
          var s = map[i][j] + map[i + 1][j];
          if (!gates[s]) gates[s] = [];
          if (isPath(map, i + 2, j)) {
            gates[s].push([i + 2, j]);
          } else {
            gates[s].push([i - 1, j]);
          }
          if (gates[s].length == 2) {
            var gate1 = gates[s][0][0] + "," + gates[s][0][1];
            var gate2 = gates[s][1][0] + "," + gates[s][1][1];
            portals[gate1] = gates[s][1];
            portals[gate2] = gates[s][0];
          }
        }
        if (isLetter(map, i, j) && isLetter(map, i, j + 1)) {
          var s = map[i][j] + map[i][j + 1];
          if (!gates[s]) gates[s] = [];
          if (isPath(map, i, j + 2)) {
            gates[s].push([i, j + 2]);
          } else {
            gates[s].push([i, j - 1]);
          }
          if (gates[s].length == 2) {
            var gate1 = gates[s][0][0] + "," + gates[s][0][1];
            var gate2 = gates[s][1][0] + "," + gates[s][1][1];
            portals[gate1] = gates[s][1];
            portals[gate2] = gates[s][0];
          }
        }
      }
    }

    var startX = gates["AA"][0][0];
    var startY = gates["AA"][0][1];
    var endX = gates["ZZ"][0][0];
    var endY = gates["ZZ"][0][1];

    return minPath(Utils.duplicate(map), startX, startY, endX, endY, portals);
  }

  function minPath(map, startX, startY, endX, endY, portals) {
    var q = [[startX, startY, 0]];
    while (q.length > 0) {
      var pos = q.shift();
      var [x, y, n] = pos;
      if (x == endX && y == endY) return n;
      if (isPath(map, x, y)) {
        map[x][y] = "#";
        q.push([x - 1, y, n + 1]);
        q.push([x + 1, y, n + 1]);
        q.push([x, y - 1, n + 1]);
        q.push([x, y + 1, n + 1]);
        var portal = portals[x + "," + y];
        if (portal) {
          q.push([portal[0], portal[1], n + 1]);
        }
      }
    }
  }

  function isLetter(map, i, j) {
    return (
      i >= 0 &&
      i < map.length &&
      j >= 0 &&
      j < map[i].length &&
      map[i][j] != " " &&
      map[i][j] != "." &&
      map[i][j] != "#"
    );
  }

  function isPath(map, i, j) {
    return (
      i >= 0 &&
      i < map.length &&
      j >= 0 &&
      j < map[i].length &&
      map[i][j] == "."
    );
  }

  var dataset = [];

  dataset.push({
    input: `         A           
         A           
  #######.#########  
  #######.........#  
  #######.#######.#  
  #######.#######.#  
  #######.#######.#  
  #####  B    ###.#  
BC...##  C    ###.#  
  ##.##       ###.#  
  ##...DE  F  ###.#  
  #####    G  ###.#  
  #########.#####.#  
DE..#######...###.#  
  #.#########.###.#  
FG..#########.....#  
  ###########.#####  
             Z       
             Z       `,
    output: 23
  });

  dataset.push({
    input: `                   A               
                   A               
  #################.#############  
  #.#...#...................#.#.#  
  #.#.#.###.###.###.#########.#.#  
  #.#.#.......#...#.....#.#.#...#  
  #.#########.###.#####.#.#.###.#  
  #.............#.#.....#.......#  
  ###.###########.###.#####.#.#.#  
  #.....#        A   C    #.#.#.#  
  #######        S   P    #####.#  
  #.#...#                 #......VT
  #.#.#.#                 #.#####  
  #...#.#               YN....#.#  
  #.###.#                 #####.#  
DI....#.#                 #.....#  
  #####.#                 #.###.#  
ZZ......#               QG....#..AS
  ###.###                 #######  
JO..#.#.#                 #.....#  
  #.#.#.#                 ###.#.#  
  #...#..DI             BU....#..LF
  #####.#                 #.#####  
YN......#               VT..#....QG
  #.###.#                 #.###.#  
  #.#...#                 #.....#  
  ###.###    J L     J    #.#.###  
  #.....#    O F     P    #.#...#  
  #.###.#####.#.#####.#####.###.#  
  #...#.#.#...#.....#.....#.#...#  
  #.#####.###.###.#.#.#########.#  
  #...#.#.....#...#.#.#.#.....#.#  
  #.###.#####.###.###.#.#.#######  
  #.#.........#...#.............#  
  #########.###.###.#############  
           B   J   C               
           U   P   P               `,
    output: 58
  });

  dataset.push({
    input: `                                           R     L     J           M H         A         Q                                       
                                           E     B     X           T P         B         I                                       
  #########################################.#####.#####.###########.#.#########.#########.#####################################  
  #.#...#...#...#.#...#.....#.#...#.#.#.#.#.#.....#.....#...#.....#.#...#.#.......#.#.........#.....#.#.#.#...#.....#.#.......#  
  #.#.###.#####.#.#.#.#####.#.#.###.#.#.#.#.#.#.#####.###.#.###.#.#.###.#.###.#.###.###.#########.###.#.#.#.###.#####.###.#####  
  #.....#.#.......#.#.#.......#...#.#.......#.#...#.#.#...#...#.#.#.#.....#...#.#.#...............#.#.#.#.....#.#...#.#.#.#...#  
  #.#.###.#######.###.###.#.#.#.###.#.#######.#####.#.#.###.###.#.#.###.#####.###.###.###########.#.#.#.###.###.#.###.#.#.#.###  
  #.#.....#.#.#...#...#...#.#.......#.#.....#.......#.#.#.....#.#.#.#.#.....#.......#...#.#.#...#.......#.....#.#.......#.#.#.#  
  #######.#.#.###.###.#####.#.###.###.#.###.#.#.#####.#.#.#####.#.#.#.###.#########.#.###.#.#.###.###.#######.#.#.###.###.#.#.#  
  #.....#.#...#...#.........#.#.........#.#.#.#...#.....#...#.#.#...#.......#.....#.#.....#...#...#.....#...........#.#.#.....#  
  ###.###.#.#####.#################.#.#.###.#.###########.###.#.#######.#####.###.#.#####.#.#################.#.#.#####.#.#.#.#  
  #...#.#...#.....#...#...#.....#...#.#.#...#.....#.......#.#.#.......#.#...#...#...#.......#...#.#.#...#.....#.#.........#.#.#  
  ###.#.###.#.###.#.#.###.#####.###.#.#####.#.#######.#####.#.###.#####.#.#.###.###.#######.#.###.#.#.###.#.#.#######.#########  
  #.......#.#.#...#.#...#.......#.#.#.#.#...#.#.#...#.....#.....#...#...#.#.#.....#...#.......#.......#...#.#.......#.#.#.....#  
  #.#.#.###.#####.#####.###.###.#.#####.###.#.#.###.#.#######.#.###.#.#.#.#.#.###.#####.#.###.#.###.#.#######.#########.#.#####  
  #.#.#.#.#.#.......#.....#.#.............#.#.....#.......#...#.....#.#.#.#.#.#.#.#...#.#.#...#.#.#.#.#.#.......#.#.#.#...#...#  
  #####.#.#.#####.#.###.#######.#.###.###.#.#.#####.#.#######.#.#.###.###.#.#.#.###.###.#####.#.#.###.#.#######.#.#.#.###.#.###  
  #.........#.#...#...#.......#.#.#...#.....#...#.#.#.....#.#.#.#.#.......#.#.....#.......#.........#.#.#...#.#.....#...#.#...#  
  #########.#.#######.#.###.#####.###.#########.#.###.#####.#.###.###.#.#.#.#.###.###.#.#.#####.#######.#.###.#.#######.#.#.###  
  #.......#.......#...#.#.#...#.#...#.......#.....#.....#...#...#...#.#.#.#.#...#...#.#.#.#.#.#...#.#...#.#.#...#...#.......#.#  
  #####.#######.###.#####.#.#.#.#######.#####.#######.#####.###.###########.#.#######.#####.#.#####.#.###.#.###.###.###.#####.#  
  #.....#...#.........#.#...#...#.#.#.#...#.....#.#.........#...#...#.#.....#.......#...........#.....#...............#.#.#.#.#  
  #####.#.###.#.###.###.#.#####.#.#.#.#.#####.###.#########.#.###.###.###.#########.###.#########.###.###.#####.###.###.#.#.#.#  
  #.#...#.#.#.#...#.....#.#.#.#...#.......#...#.....#.......#.....#.#...#...#.......#.....#...#...#.#.#.#.#...#.#.#.#.....#.#.#  
  #.###.#.#.#######.#.#####.#.#.#####.#####.#.#.#.###.#########.###.###.###.#.###.#.#.#.###.#####.#.#.#.###.###.#.#####.#.#.#.#  
  #.#.#.#.#.#.#.#...#.#.#.#.....#...#...#...#...#.#.........#...#...#...#.#.#...#.#.#.#.......#...#.#.#.#.....#...#.#...#.#.#.#  
  #.#.#.#.#.#.#.#####.#.#.#####.###.#.###.#.#####.#########.#.###.#####.#.#.###.#.###.###########.#.###.###.#.#.###.#.#.###.#.#  
  #...#.#...#...#.#.#...#.........#.....#.#.#.......#.....#.#.#.....#.....#.#...#.#.......#...#.#.....#.#...#.#.......#...#...#  
  #.###.#.#####.#.#.#.###.#####.#####.#######.###.###.#.###.#.#.###.###.#.#.#.#######.#######.#.#.#####.###.#.###.#########.###  
  #...#...#.#...........#.#...#.#.........#.#.#.....#.#.....#.#.#.#...#.#...#.#.....#.......#.#...........#.#.......#.#.#.....#  
  ###.###.#.#######.#.#####.#.#.#####.###.#.#######.#.#######.#.#.#.###.#####.#.###.###.#.###.#.###.#.###.###.###.###.#.###.###  
  #.......#.#.#.#...#...#...#.......#...#...#...#...#...#.#.....#...#.....#.....#.#...#.#.........#.#.#.....#.#.#.#.#.#.#.#...#  
  #######.#.#.#.#####.#.#####.#.#.###.#########.#.###.###.###.###.#######.#######.#.#######.###.#.#############.#.#.#.#.#.#.###  
  #.#.........#.#.#...#.#...#.#.#.........#.........#.......#...#.....#...#...........#.....#...#.#.....#...#...#...#...#.#.#.#  
  #.#.#####.###.#.###.#####.#####.#####.###########.#####.#########.###.#####.###########.#########.#.###.#.###.#.###.###.#.#.#  
  #...#...#.#...#.........#.#.#...#    U           J     B         J   C     L           W    #.#...#.#.#.#.#.......#.#.#.....#  
  ###.#.#######.###.#.#####.#.###.#    X           K     K         X   M     B           A    #.#.#####.###.#####.###.#.###.###  
  #...#...#.........#.#.#.#...#...#                                                           #...........#...#...#.......#...#  
  ###.#.#############.#.#.###.#####                                                           #.###.###.#.#.#.#.#.#.###.#.#.#.#  
  #.#.......#...........#.........#                                                         EV..#...#.#.#...#...#.#.#.#.#...#..OS
  #.###.#.#####.#####.#.#.#.###.#.#                                                           #.#.#.#.#.#.#######.#.#.#####.#.#  
ZL..#...#...#.......#.#...#...#.#.#                                                           #.#.#...#.#.#.#...........#...#.#  
  #.#.#.###.#####.#.###.#.#.###.###                                                           #.###########.#########.#########  
  #...#.#.......#.#.#.#.#.#.#......HP                                                         #...#...........#.....#.#.#...#.#  
  #############.#.###.#########.#.#                                                           ###.###.#######.#.#.#####.#.#.#.#  
  #...#...#.......#.#.#.#.#...#.#.#                                                           #.#.#...#...#.....#.....#...#.#..TG
  #.###.#####.#####.#.#.#.###.#####                                                           #.#####.#.#.#####.#####.###.###.#  
  #.......#...#...................#                                                         QI......#...#...#.#.#.....#.....#.#  
  #.###.#####.###.###.#.###.#.#.###                                                           #.###.###.#####.#####.###.###.#.#  
  #...#.....#.#.....#.#.#...#.#....SL                                                         #...#.....#...#.#...........#...#  
  ###.#.#######.###.###.#####.#.#.#                                                           ###########.###.#################  
CM....#.#.........#...#...#.#.#.#.#                                                           #.........#.....#.......#.#.....#  
  ###.#.###.###############.#######                                                           ###.###.###.###.#.###.#.#.#.#.###  
  #...#.......#.....#.#.#.....#...#                                                           #.#.#.#...#...#.....#.#...#.#....SL
  ###############.###.#.#.#.#####.#                                                           #.#.#.#.#####.#######.###.#.#####  
  #.#.#...............#...#.#.#...#                                                           #.....#.....#.....#.....#...#.#.#  
  #.#.#.#####.#.#.#.#####.###.#.###                                                           #####.#####.#.#####.#######.#.#.#  
  #.......#.#.#.#.#.#.#.....#.#...#                                                         FE......#.......#...#.#...#.#.#.#.#  
  #.#######.###.###.#.#####.#.#.#.#                                                           #################.###.###.###.#.#  
WF....#...#.#.....#.#...#...#.#.#..MK                                                         #...#.#.........................#  
  #####.###.###.#.#####.#.#.#.###.#                                                           #.###.#.#####.###.###.#.#.###.#.#  
  #.........#...#.........#.......#                                                           #...#.#.....#...#.#.#.#.#.#...#.#  
  #####.#.#####.#####.###.#######.#                                                           #.###.#.#.###.###.#.###.#####.#.#  
  #.....#.....#.#.....#.#.#.......#                                                         AT....#...#...#.#...#...#.#.#.#.#..JK
  #.###.#######.#.#.###.#.#####.#.#                                                           #.###.#.###########.###.#.#.#####  
  #.#.....#...#.#.#...#...#.#.#.#.#                                                           #.....#.......#.....#.#.#...#...#  
  #.#.###.#.#############.#.#.#####                                                           #####.#########.###.#.#####.#.###  
FE..#.#...#...#...#.#.#.#.#.#.#....BR                                                         #...#.....#.#.#.#.....#...#.....#  
  #####.#####.#.###.#.#.###.#.###.#                                                           #.#########.#.#####.###.###.#.###  
  #.#.............................#                                                         OS......#.#.#...#.#.#.#.#.....#...#  
  #.###.#.#.###.#.#.###.#######.###                                                           ###.###.#.###.#.#.#.#.###.###.###  
  #.#...#.#.#...#.#.#.#.#.....#.#..UU                                                         #...........#.#.#.........#...#..WA
  #.###.###.#####.###.#####.#.###.#                                                           #####.###.###.#.#.#.#.#######.#.#  
BK..#.....#.....#...#...#.#.#.#...#                                                           #.#...#.#.........#.#.#...#.#...#  
  #.#################.###.#.#.###.#                                                           #.#####.#################.#.#####  
  #.#...#.#.#.............#.#.....#                                                         TG......#...#...........#.......#..OJ
  #.###.#.#.#####.#####.#.#.#.###.#                                                           ###.#.#.#.#.#####.#.#.#.#.#####.#  
MK..................#.#.#...#.#....AB                                                         #...#...#...#...#.#.#...#.....#.#  
  #######.#.#.#.#.###.###########.#                                                           ###########.###.#####.#######.#.#  
  #.....#.#.#.#.#.#.#.........#.#.#                                                           #.#.#.#.......#.#...#.#.#.#.....#  
  #.###.###########.###.###.#.#.###                                                           #.#.#.#########.###.###.#.#####.#  
  #.#.#.....#.#...#.#.....#.#.#.#.#                                                         EN........#...#...#.............#.#  
  #.#.#.#####.###.#.#####.###.#.#.#                                                           #.###.#####.#.#.#.###.#######.###  
  #...#.#.#.......#...#...#.#.#.#..FD                                                         #...#.....#...#.....#.#.....#.#..UX
  ###.#.#.#.#.#.###.#.#.###.#.#.#.#                                                           #.###.#.#.#.#.#.#.#.###.###.#.#.#  
EN....#.....#.#.....#.....#.......#                                                           #.#.#.#.#...#.#.#.#...#...#...#.#  
  #.#####.#.#####.#.#####.#.#.###.#                                                           ###.#.#####.###.###.#####.#####.#  
  #.....#.#.....#.#.#...#.#.#...#.#                                                           #.......#...#...#.....#.........#  
  #.#######.#####.#.###.#####.###.#            M   O           X     W         R     Z        ###.#####.#.###.###.#.#.###.#.###  
  #.#.....#.....#.#.......#.....#.#            T   J           H     F         E     L        #.....#...#...#.#...#.#.#.#.#...#  
  #.#.#####.#########.#####.###.###############.###.###########.#####.#########.#####.#################.#.###.#####.#.#.#.#.#.#  
  #...#.......#.........#...#.....#.....#.........#.....#.....#.#.......#.......#...#...........#.#.....#.#.#.....#.#...#.#.#.#  
  #.###.#.#.#####.#.#.###.#.#####.###.#.#.#####.#######.#.###.#.#.#######.#######.#.###.###.#####.#########.#.#.#######.#.###.#  
  #.#...#.#...#...#.#...#.#.....#.#.#.#.#.#.....#...#...#.#.....#.....#.........#.#.......#.....#...#.#.......#.......#.#...#.#  
  #.#.#####.#.#.#####.#####.#######.#.#########.#.###.###.###########.#####.###.#.###########.###.###.###.#.#.###.###.###.###.#  
  #.#.....#.#.#.#.........#...#...#.#.#.#...#...#.......#.........#.#...#.#.#...#.....#.#.#...#.#.#.#.....#.#.#.....#...#.#.#.#  
  #.###.###########.#.#.#########.#.#.#.#.#####.#.###.#####.#.#.###.###.#.#####.#.#.#.#.#.#####.#.#.#####.###.#.#.#.###.###.###  
  #...#...#...#.....#.#.#.#.........#.#.#.#.....#...#.....#.#.#.....#.....#.....#.#.#...#...........#.#...#...#.#.#.#.......#.#  
  #.#.#.#####.#.###.#####.#.#######.#.#.#.#####.#.#############.#.###.###.###.#######.#.#.#######.###.#.#.###.#.#.###.#####.#.#  
  #.#.#...#.#...#...#.#...#.#...................#.....#.#.#.#...#.#.....#.#...#.#...#.#.........#.....#.#.#...#.#...#...#.....#  
  ###.#####.#.#####.#.###.#####.#####.###.#####.#####.#.#.#.###.#.#.###.###.#.#.#.#####.###.#.#####.#.#.#.#.#.###.#####.#####.#  
  #...#.......#.........#.....#.#.....#.#...#...#.......#.......#.#.#.....#.#.....#.#.....#.#...#...#.#.#.#.#.#.......#...#.#.#  
  #####.###.###.###.#.#.#####.#########.###.#.#####.###.#####.###.###.###.#####.###.#.#.#.#.#.#.###.#####.#.###.#######.#.#.#.#  
  #.#...#.....#.#.#.#.#.#...#...#...#.......#.#...#.#.....#.#...#.#.....#.#.#...#...#.#.#.#.#.#.#.......#.#.#.....#.....#.#...#  
  #.#.#####.#.###.#.#.###.#.#.###.###.###.#.#####.#####.###.#.#####.#.#####.#.#.#.#####.###.#.#####.###.###.###.#.#########.#.#  
  #.....#...#.#.....#.#...#.........#.#...#...#...#.......#.#.....#.#.#.....#.#.....#...#.#.#...#.#.#...#.....#.#.......#...#.#  
  ###.#.###.#####.#.###############.#####.#######.###.#.###.###.#####.#####.###.#######.#.#.###.#.#########.#.###.#.#####.#.#.#  
  #...#.#.....#...#.#.....................#...#.#.#...#.#.....#.....#...#.......#...#.....#.#.#.....#.#.#...#.#.#.#...#...#.#.#  
  #.#.#####.#########.###.#.#####.#####.#.###.#.#.#####.#.#.###.###.###.###.#####.#####.#####.#.#####.#.#.#.###.#.#.###.#.###.#  
  #.#...#.........#...#.#.#.#.........#.#...#...#...#.#.#.#.#.....#.#.....#.......#.#.....#.#...#.#.#...#.#.....#.#...#.#.#...#  
  #####.#####.#.###.###.#########.#######.#.###.#.#.#.#.#.#.#.#.#.#####.###.###.#.#.###.###.#####.#.#.#.###.#.###.#.#.#.#.###.#  
  #.#...#.....#.#.#...#...#.......#.......#.#.....#.#.#.#.#...#.#.#.#...#...#...#.#...........#.#.#...#...#.#...#.#.#.#.#...#.#  
  #.#.#######.###.#####.###.###.#.#####.#.#######.#.###.#.#.#######.###.#######.#.#####.#.###.#.#.#.#############.#.#####.###.#  
  #.....#.......#...........#...#.#...#.#...#.#...#.....#.#...#.........#...#.#.#...#...#...#.............#.#.#.#.#...#.....#.#  
  #.#.#######.###.#.###.#.###.#.#####.#.#.#.#.###.#######.###.#.#######.#.###.#.#####.#.#########.###.###.#.#.#.###.#.#.#.#.###  
  #.#.#.........#.#.#...#.#...#.#...#.#.#.#.#.#...#...#.....#.#.#.#.........#.....#...#.........#...#...#.......#...#.#.#.#...#  
  #.#.#####.###.###.###.###.#.#####.#.###.###.###.#.#.#####.#####.#####.#######.###.###.###.#####.#####.#.###########.#.###.###  
  #.#.#.......#.#.#.#.....#.#...#.............#.....#.#.......#.#.#.....#...#.....#.#...#.......#.....#.#.........#...#.#.#...#  
  ###.#####.#.#.#.#####.###.#######.###.#####.###.###.###.#####.#.#####.#.###.#.#######.#####.#####.#########.###########.#.#.#  
  #...#.....#.#.#.........#.#.....#.#.....#.....#.#.....#.........#.#.#.....#.#.....#.#...#.....#...........#.......#.......#.#  
  #.#.#####.#####.#.#.#.#.#######.#####.#######.#######.#######.###.#.#.#######.#####.#.#####.###.###.#####.#.#######.#####.###  
  #.#.#.....#.....#.#.#.#.#.............#.........#.......#.....#.......#...........#.....#...#...#.......#.#.......#.#.......#  
  #########################################.###.###.###.###.#####.#########.#########.#########################################  
                                           X   A   B   Z   A     F         E         U                                           
                                           H   A   R   Z   T     D         V         U                                           `,
    output: 658
  });

  Utils.check(solve, dataset, "20a");
})();
