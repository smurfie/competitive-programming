(() => {
  function solve(input) {
    var lines = Utils.read(input);
    var m = lines.map((i) => i.split(""));
    var max = 0;
    var spotX = -1;
    var spotY = -1;

    for (var i = 0; i < m.length; i++) {
      for (var j = 0; j < m[0].length; j++) {
        if (m[i][j] == "X") {
          spotX = i;
          spotY = j;
        }
      }
    }

    if (spotX == -1) {
      for (var i = 0; i < m.length; i++) {
        for (var j = 0; j < m[0].length; j++) {
          if (m[i][j] == "#") {
            var n = count(m, i, j);
            if (n > max) {
              max = n;
              spotX = i;
              spotY = j;
            }
          }
        }
      }
    }

    m[spotX][spotY] = "X";
    var asters = [];
    for (var i = 0; i < m.length; i++) {
      for (var j = 0; j < m[0].length; j++) {
        if (m[i][j] == "#") {
          var dx = i - spotX;
          var dy = j - spotY;
          var q;
          if (dx < 0 && dy >= 0) q = 0;
          if (dx >= 0 && dy > 0) q = 1;
          if (dx >= 0 && dy < 0) q = 2;
          if (dx < 0 && dy < 0) q = 3;
          asters.push([i, j, dx / dy, q, Math.abs(dx == 0 ? dy : dx), dx, dy]);
        }
      }
    }

    asters.sort((a, b) => {
      var res = a[3] - b[3];
      if (res == 0) res = a[2] - b[2];
      if (res == 0 || isNaN(res)) res = a[4] - b[4];
      return res;
    });

    var it = 1;
    var i = 0;
    var val = asters[0][2];
    var q = 0;
    var dict = { 0: true };
    while (it != 200) {
      i = (i + 1) % asters.length;
      if (i == 0) {
        val = null;
        q = null;
      }
      if (!dict[i] && (asters[i][2] != val || asters[i][3] != q)) {
        it++;
        dict[i] = true;
        val = asters[i][2];
        q = asters[i][3];
      }
    }

    return asters[i][1] * 100 + asters[i][0];
  }

  function count(m, i, j) {
    var sum = 0;
    for (var i2 = 0; i2 < m.length; i2++) {
      for (var j2 = 0; j2 < m[0].length; j2++) {
        if (
          m[i2][j2] == "#" &&
          (i != i2 || j != j2) &&
          visible(m, i, j, i2, j2)
        )
          sum++;
      }
    }
    return sum;
  }

  function visible(m, x1, y1, x2, y2) {
    var rx = x2 - x1;
    var ry = y2 - y1;

    if (rx == 0) {
      for (i = Math.min(y1, y2) + 1; i < Math.max(y1, y2); i++) {
        if (m[x1][i] == "#") return false;
      }
      return true;
    }
    if (ry == 0) {
      for (i = Math.min(x1, x2) + 1; i < Math.max(x1, x2); i++) {
        if (m[i][y1] == "#") return false;
      }
      return true;
    }

    var div = mcd(Math.abs(rx), Math.abs(ry));
    var ix = rx / div;
    var iy = ry / div;
    var tmpx = x1 + ix;
    var tmpy = y1 + iy;
    while (tmpx != x2) {
      if (m[tmpx][tmpy] == "#") return false;
      tmpx += ix;
      tmpy += iy;
    }
    return true;
  }

  function mcd(a, b) {
    if (b < a) [a, b] = [b, a];
    if (a == 0) return b;
    return mcd(b % a, a);
  }

  var dataset = [];

  dataset.push({
    input: `.#..##.###...#######
##.############..##.
.#.######.########.#
.###.#######.####.#.
#####.##.#.##.###.##
..#####..#.#########
####################
#.####....###.#.#.##
##.#################
#####.##.###..####..
..######..##.#######
####.##.####...##..#
.#####..#.######.###
##...#.##########...
#.##########.#######
.####.#.###.###.#.##
....##.##.###..#####
.#.#.###########.###
#.#.#.#####.####.###
###.##.####.##.#..##`,
    output: 802
  });

  dataset.push({
    input: `.#....#.###.........#..##.###.#.....##...
...........##.......#.#...#...#..#....#..
...#....##..##.......#..........###..#...
....#....####......#..#.#........#.......
...............##..#....#...##..#...#..#.
..#....#....#..#.....#.#......#..#...#...
.....#.#....#.#...##.........#...#.......
#...##.#.#...#.......#....#........#.....
....##........#....#..........#.......#..
..##..........##.....#....#.........#....
...#..##......#..#.#.#...#...............
..#.##.........#...#.#.....#........#....
#.#.#.#......#.#...##...#.........##....#
.#....#..#.....#.#......##.##...#.......#
..#..##.....#..#.........#...##.....#..#.
##.#...#.#.#.#.#.#.........#..#...#.##...
.#.....#......##..#.#..#....#....#####...
........#...##...#.....#.......#....#.#.#
#......#..#..#.#.#....##..#......###.....
............#..#.#.#....#.....##..#......
...#.#.....#..#.......#..#.#............#
.#.#.....#..##.....#..#..............#...
.#.#....##.....#......##..#...#......#...
.......#..........#.###....#.#...##.#....
.....##.#..#.....#.#.#......#...##..#.#..
.#....#...#.#.#.......##.#.........#.#...
##.........#............#.#......#....#..
.#......#.............#.#......#.........
.......#...##........#...##......#....#..
#..#.....#.#...##.#.#......##...#.#..#...
#....##...#.#........#..........##.......
..#.#.....#.....###.#..#.........#......#
......##.#...#.#..#..#.##..............#.
.......##.#..#.#.............#..#.#......
...#....##.##..#..#..#.....#...##.#......
#....#..#.#....#...###...#.#.......#.....
.#..#...#......##.#..#..#........#....#..
..#.##.#...#......###.....#.#........##..
#.##.###.........#...##.....#..#....#.#..
..........#...#..##..#..##....#.........#
..#..#....###..........##..#...#...#..#..`,
    output: 2628
  });

  Utils.check(solve, dataset, "10b");
})();
